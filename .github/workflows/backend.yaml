name: GitOps EKS Deployment â€“ Multi Env

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: write
  packages: write

jobs:

  # =========================
  # DEV
  # =========================
  dev:
    if: github.ref_name == 'main'
    uses: Tohands-Private-Limited/deployment-workflows/.github/workflows/centralized-workflow.yaml@main
    with:
      environment: dev
      source_branch: main
      image_registry: ghcr.io/tohands-private-limited/tohands-backend-internal
      validate_deploy: true
      app_name: tohands-backend
      namespace: tohands-stack
      helm_repo: Tohands-Private-Limited/deployment-workflows
      helm_values_file: charts/tohands-backend/dev-values.yaml
      eks_cluster: dev-eks-cluster
      aws_region: ap-south-1
      argocd_server: argocd.dev.tohands.in
      sonar_host_url: https://sonarqube.tohands.in/
      sonar_project_key: tohands-backend-internal
    secrets:
      ARGO_TOKEN: ${{ secrets.ARGO_DEV_TOKEN }}

  # =========================
  # STAGE
  # =========================
  stage:
    if: github.ref_name == 'staging'
    uses: Tohands-Private-Limited/deployment-workflows/.github/workflows/centralized-workflow.yaml@main
    with:
      environment: stage
      source_branch: staging
      image_registry: ghcr.io/tohands-private-limited/tohands-backend-internal
      validate_deploy: true
      app_name: tohands-backend
      namespace: tohands-stack
      helm_repo: Tohands-Private-Limited/deployment-workflows
      helm_values_file: charts/tohands-backend/stage-values.yaml
      eks_cluster: stage-eks-cluster
      aws_region: ap-south-1
      argocd_server: argocd.stage.tohands.in
    secrets:
      ARGO_TOKEN: ${{ secrets.ARGO_STAGE_TOKEN }}

  # =========================
  # STAGE DR
  # =========================
  stage-dr:
    needs: stage
    if: github.ref_name == 'staging'
    uses: Tohands-Private-Limited/deployment-workflows/.github/workflows/centralized-workflow.yaml@main
    with:
      environment: stage-dr
      source_branch: staging
      image_registry: ghcr.io/tohands-private-limited/tohands-backend-internal
      validate_deploy: true
      app_name: tohands-backend
      namespace: tohands-stack
      helm_repo: Tohands-Private-Limited/deployment-workflows
      helm_values_file: charts/tohands-backend/stage-dr-values.yaml
      eks_cluster: stage-dr-eks-cluster
      aws_region: us-east-1
      argocd_server: argocd.stage-dr.tohands.in
    secrets:
      ARGO_TOKEN: ${{ secrets.ARGO_STAGE_DR_TOKEN }}

  # =========================
  # PROD
  # =========================
  prod:
    if: github.ref_name == 'main'
    uses: Tohands-Private-Limited/deployment-workflows/.github/workflows/centralized-workflow.yaml@main
    with:
      environment: prod
      source_branch: main
      image_registry: 123456789012.dkr.ecr.us-west-2.amazonaws.com/sample-app
      validate_deploy: true
      app_name: tohands-backend
      namespace: tohands-stack
      helm_repo: Tohands-Private-Limited/deployment-workflows
      helm_values_file: charts/tohands-backend/prod-values.yaml
      eks_cluster: prod-eks-cluster
      aws_region: us-west-2
      argocd_server: argocd.prod.tohands.in
    secrets:
      ARGO_TOKEN: ${{ secrets.ARGO_PROD_TOKEN }}

  # =========================
  # PROD DR
  # =========================
  prod-dr:
    needs: prod
    if: github.ref_name == 'main'
    uses: Tohands-Private-Limited/deployment-workflows/.github/workflows/centralized-workflow.yaml@main
    with:
      environment: prod-dr
      source_branch: main
      image_registry: 123456789012.dkr.ecr.us-east-1.amazonaws.com/sample-app
      validate_deploy: true
      app_name: tohands-backend
      namespace: tohands-stack
      helm_repo: Tohands-Private-Limited/deployment-workflows
      helm_values_file: charts/tohands-backend/prod-dr-values.yaml
      eks_cluster: prod-dr-eks-cluster
      aws_region: us-east-1
      argocd_server: argocd.prod-dr.tohands.in
    secrets:
      ARGO_TOKEN: ${{ secrets.ARGO_PROD_DR_TOKEN }}
